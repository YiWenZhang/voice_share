{% extends "admin/dashboard.html" %}

{% block admin_main %}

<style>
    /* --- 权限可视化样式 --- */
    .perm-container {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        max-height: 400px;
        overflow-y: auto;
        padding-right: 5px;
    }

    .perm-card {
        background: #fff;
        border-radius: 8px;
        padding: 0.8rem;
        border: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        transition: transform 0.2s;
    }

    .perm-card:hover {
        transform: translateX(4px);
        border-color: #cbd5e1;
    }

    .perm-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 700;
        color: #475569;
        font-size: 0.9rem;
        border-bottom: 1px dashed #f1f5f9;
        padding-bottom: 0.4rem;
    }

    .perm-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
    }

    .p-badge {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    /* 权限颜色定义 */
    .p-select { background: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; } /* 读-蓝 */
    .p-insert { background: #f0fdf4; color: #16a34a; border: 1px solid #dcfce7; } /* 增-绿 */
    .p-update { background: #fff7ed; color: #ea580c; border: 1px solid #ffedd5; } /* 改-橙 */
    .p-delete { background: #fef2f2; color: #dc2626; border: 1px solid #fee2e2; } /* 删-红 */
    .p-all    { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; box-shadow: 0 2px 5px rgba(245, 158, 11, 0.3); } /* 超级权限-金 */

    /* 特殊标记 */
    .danger-zone {
        border: 1px solid #fca5a5;
        background: #fff1f2;
    }
</style>

<div class="module-header">
  <div class="module-title">
    <h1><i class="{{ icon }}" style="color: #6366f1; font-size: 0.9em; vertical-align: middle;"></i> {{ title }}</h1>
    <p>{{ subtitle }}</p>
  </div>
  <div class="header-status">
    <span style="background: rgba(16, 185, 129, 0.1); color: #059669; padding: 0.6rem 1.2rem; border-radius: 99px; font-weight: 600; border: 1px solid rgba(16, 185, 129, 0.2); display: flex; align-items: center; gap: 6px;">
      <i class="ri-checkbox-circle-fill"></i> 系统正常
    </span>
  </div>
</div>


<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 2.5rem;">

  {% if active_page == 'health' %}

    {# --- 模式 A: 详情模式 (显示特定表的索引和外键) --- #}
    {% if detail_mode %}
      <div class="dashboard-card" style="grid-column: 1 / -1;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 1rem;">
            <h3 style="margin: 0; color: #1e293b; display: flex; align-items: center; gap: 0.8rem;">
                <span style="background: #e0e7ff; color: #4338ca; padding: 4px 10px; border-radius: 8px; font-size: 0.9em;">Table</span>
                {{ table_name }}
            </h3>
            <a href="{{ url_for('admin.db_health') }}" class="modern-action-btn" style="background: #fff; border: 1px solid #cbd5e1; color: #64748b; padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none;">
                <i class="ri-arrow-left-line"></i> 返回概览
            </a>
        </div>

        <h4 style="color: #6366f1; margin: 1.5rem 0 1rem;"><i class="ri-list-check"></i> 索引定义 (Indexes)</h4>
        <div class="table-scroll">
          <table class="data-table">
            <thead>
                <tr>
                    <th>Key Name</th>
                    <th>Seq</th>
                    <th>Column</th>
                    <th>Unique</th>
                    <th>Type</th>
                    <th>Cardinality</th>
                </tr>
            </thead>
            <tbody>
              {% for row in indexes %}
              <tr>
                  <td style="font-weight: 600; color: #334155;">{{ row.Key_name }}</td>
                  <td>{{ row.Seq_in_index }}</td>
                  <td style="color: #0f766e; background: #f0fdfa; border-radius: 4px; padding: 2px 6px;">{{ row.Column_name }}</td>
                  <td>
                      {% if row.Non_unique == 0 %}
                        <span style="color: #15803d; background: #dcfce7; padding: 2px 6px; border-radius: 4px; font-size: 0.85rem;">YES</span>
                      {% else %}
                        <span style="color: #94a3b8;">NO</span>
                      {% endif %}
                  </td>
                  <td>{{ row.Index_type }}</td>
                  <td>{{ row.Cardinality }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <h4 style="color: #f59e0b; margin: 2.5rem 0 1rem;"><i class="ri-link"></i> 外键约束 (Foreign Keys)</h4>
        <div class="table-scroll">
            <table class="data-table">
                <thead><tr><th>Constraint Name</th><th>Column</th><th>Ref Table</th><th>Ref Column</th></tr></thead>
                <tbody>
                    {% for fk in fks %}
                    <tr>
                        <td>{{ fk.CONSTRAINT_NAME }}</td>
                        <td>{{ fk.COLUMN_NAME }}</td>
                        <td style="color: #3b82f6;">{{ fk.REFERENCED_TABLE_NAME }}</td>
                        <td>{{ fk.REFERENCED_COLUMN_NAME }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4" style="text-align: center; color: #cbd5e1; padding: 1rem;">无外键约束</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
      </div>

{# --- 模式 B: 概览模式 (卡片网格) --- #}
    {% else %}
      <div class="dashboard-card" style="grid-column: 1 / -1; background: transparent !important; box-shadow: none !important; border: none !important; padding: 0 !important;">

        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
            {% for t in tables %}
            <a href="{{ url_for('admin.db_health', table=t.TABLE_NAME) }}" class="db-table-card" style="text-decoration: none; color: inherit;">
                <div style="background: #fff; border-radius: 16px; padding: 1.5rem; border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 4px 6px rgba(0,0,0,0.02); transition: all 0.3s ease; position: relative; overflow: hidden; height: 100%; display: flex; flex-direction: column;">

                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: {{ 'linear-gradient(90deg, #d8b4fe, #c084fc)' if t.TABLE_TYPE == 'VIEW' else 'linear-gradient(90deg, #6366f1, #a855f7)' }};"></div>

                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; flex-wrap: wrap;">
                            <h3 style="margin: 0; font-size: 1.15rem; color: #1e293b; font-weight: 700; word-break: break-all;">
                                {{ t.TABLE_NAME }}
                            </h3>
                            {% if t.TABLE_TYPE == 'VIEW' %}
                                <span style="font-size: 0.65rem; background: #f3e8ff; color: #9333ea; padding: 2px 6px; border-radius: 4px; font-weight: 700; border: 1px solid #e9d5ff; flex-shrink: 0;">VIEW</span>
                            {% else %}
                                <span style="font-size: 0.65rem; background: #f1f5f9; color: #64748b; padding: 2px 6px; border-radius: 4px; font-weight: 600; border: 1px solid #e2e8f0; flex-shrink: 0;">TABLE</span>
                            {% endif %}
                        </div>

                        <p style="margin: 0; font-size: 0.85rem; color: #64748b; line-height: 1.5;">
                            {{ table_desc.get(t.TABLE_NAME, '系统数据对象') }}
                        </p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: #f0fdfa; padding: 0.8rem; border-radius: 10px; text-align: center;">
                            <div style="font-size: 0.75rem; color: #0f766e; margin-bottom: 4px;">实体完整性 (PK)</div>
                            {% if t.pk_count > 0 %}
                                <div style="color: #10b981; font-weight: 800; font-size: 1.1rem;"><i class="ri-check-double-line"></i> 正常</div>
                            {% elif t.TABLE_TYPE == 'VIEW' %}
                                <div style="color: #94a3b8; font-weight: 600; font-size: 1.1rem;">N/A</div>
                            {% else %}
                                <div style="color: #ef4444; font-weight: 800; font-size: 1.1rem;"><i class="ri-alert-line"></i> 缺失</div>
                            {% endif %}
                        </div>

                        <div style="background: #fff7ed; padding: 0.8rem; border-radius: 10px; text-align: center;">
                            <div style="font-size: 0.75rem; color: #9a3412; margin-bottom: 4px;">参照完整性 (FK)</div>
                            {% if t.TABLE_TYPE == 'VIEW' %}
                                <div style="color: #94a3b8; font-weight: 600; font-size: 1.1rem;">N/A</div>
                            {% else %}
                                <div style="color: #f97316; font-weight: 800; font-size: 1.2rem;">{{ t.fk_count }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div style="margin-top: auto; display: flex; align-items: center; justify-content: space-between; border-top: 1px dashed #e2e8f0; padding-top: 1rem;">

                        <div style="display: flex; align-items: center; gap: 6px;" title="索引数量">
                            <i class="ri-key-2-line" style="color: #6366f1;"></i>
                            <span style="font-size: 0.9rem; color: #475569; font-weight: 600;">{{ t.index_count }} 索引</span>
                        </div>

                        {% if t.TABLE_TYPE == 'BASE TABLE' %}
                            <div style="display: flex; align-items: center; gap: 6px;" title="当前数据行数">
                                <i class="ri-list-check-2" style="color: #94a3b8; font-size: 0.9rem;"></i>
                                <span style="background: #f1f5f9; color: #475569; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; font-family: monospace; font-weight: 600;">
                                    {{ t.TABLE_ROWS if t.TABLE_ROWS is not none else '0' }} rows
                                </span>
                            </div>
                        {% else %}
                            <div style="color: #cbd5e1; font-size: 1.1rem;" title="视图 (虚拟表)">
                                <i class="ri-eye-line"></i>
                            </div>
                        {% endif %}
                    </div>

                    <div style="margin-top: 1rem; text-align: center; color: #3b82f6; font-size: 0.9rem; font-weight: 600; opacity: 0; transform: translateY(10px); transition: all 0.3s;" class="hover-tip">
                        点击查看详情 <i class="ri-arrow-right-line"></i>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>

        <style>
            .db-table-card:hover > div {
                transform: translateY(-5px);
                box-shadow: 0 15px 30px rgba(99, 102, 241, 0.15) !important;
                border-color: #a78bfa !important;
            }
            .db-table-card:hover .hover-tip {
                opacity: 1;
                transform: translateY(0);
            }
        </style>
      </div>
    {% endif %}

{# --- 模块：自动化运维 --- #}
  {% elif active_page == 'automation' %}

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <div class="dashboard-card">
      <div class="card-content">
        <h3 style="margin-top: 0; color: #1e293b;">
            <i class="ri-calendar-check-line" style="color: #8b5cf6; margin-right: 8px;"></i> 每日维护任务
        </h3>
        <p style="color: #64748b; line-height: 1.6; margin-bottom: 2rem;">
          调用存储过程 <code>CALL sp_daily_maintenance()</code><br>
          自动清理 1 天前的临时日志与过期会话，释放空间。
        </p>

        <div style="margin-top: auto;">
            <button id="btn-run-maintenance" class="modern-action-btn" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: #fff; padding: 1rem; width: 100%; border-radius: 12px; font-size: 1rem; border: none; cursor: pointer;">
                <i class="ri-play-circle-line"></i> 立即执行 (Run SP)
            </button>
        </div>
      </div>
    </div>

    <div class="dashboard-card">
      <div class="card-content">
        <h3 style="margin-top: 0; color: #1e293b;">
            <i class="ri-file-search-line" style="color: #3b82f6; margin-right: 8px;"></i> 审计日志
        </h3>
        <p style="color: #64748b; line-height: 1.6; margin-bottom: 2rem;">
          基于触发器 <code>trg_room_join_audit</code> 自动监控。<br>
          <span style="color: #0f766e; font-weight: 600; background: #f0fdfa; padding: 0 4px; border-radius: 4px;">只要有用户加入房间</span>，无论通过何种方式，系统都会强制记录该行为，确保人员变更可追溯。
        </p>
        <div style="margin-top: auto;">
            <a href="{{ url_for('admin.audit_logs') }}" class="modern-action-btn" style="background: #fff; border: 1px solid #cbd5e1; color: #3b82f6; padding: 1rem; width: 100%; border-radius: 12px; display: block; text-align: center; text-decoration: none; font-size: 1rem;">
              <i class="ri-eye-line"></i> 查看日志表
            </a>
        </div>
      </div>
    </div>

    <script>
    document.getElementById('btn-run-maintenance').addEventListener('click', function() {
        // 1. 弹出确认框
        Swal.fire({
            title: '确认执行维护？',
            text: "此操作将调用存储过程清理过期数据，且不可撤销。",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#8b5cf6', // 紫色按钮
            cancelButtonColor: '#cbd5e1',
            confirmButtonText: '是的，立即清理',
            cancelButtonText: '取消',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                // 2. 显示 Loading 状态
                Swal.fire({
                    title: '正在执行...',
                    text: '数据库正在跑路（划掉）整理数据中',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // 3. 发送 AJAX 请求给后端
                fetch("{{ url_for('admin.exec_maintenance') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': "{{ csrf_token() }}" // 必须带上 CSRF Token
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // 4. 根据后端返回结果弹窗
                    if (data.status === 'success') {
                        Swal.fire({
                            title: '清理成功!',
                            text: data.message,
                            icon: 'success',
                            confirmButtonColor: '#10b981'
                        });
                    } else {
                        Swal.fire({
                            title: '执行失败',
                            text: data.message,
                            icon: 'error',
                            confirmButtonColor: '#ef4444'
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        title: '网络错误',
                        text: '无法连接到服务器',
                        icon: 'error'
                    });
                });
            }
        });
    });
    </script>



  {# --- 模块：审计日志列表视图 --- #}
  {% elif active_page == 'audit_logs_view' %}
    <div class="dashboard-card" style="grid-column: 1 / -1;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 1rem;">
        <h3 style="margin:0; color: #1e293b; display: flex; align-items: center; gap: 8px;">
            <i class="ri-shield-check-line" style="color:#6366f1;"></i> 系统审计流水
            <span style="font-size: 0.8rem; color: #64748b; font-weight: normal; background: #f1f5f9; padding: 2px 8px; border-radius: 4px;">Trigger Generated</span>
        </h3>
        <a href="{{ url_for('admin.db_automation') }}" class="modern-action-btn" style="background: #fff; border: 1px solid #cbd5e1; padding: 0.5rem 1rem; text-decoration:none; color: #64748b; border-radius: 8px;">
            <i class="ri-arrow-left-line"></i> 返回
        </a>
      </div>

      <div class="table-scroll">
        <table class="data-table">
          <thead>
            <tr>
                <th style="width: 80px;">ID</th>
                <th style="width: 120px;">行为 (Type)</th>
                <th style="width: 120px;">目标表 (Table)</th>
                <th style="width: 100px;">记录ID</th>
                <th>详情描述 (Details)</th>
                <th style="width: 180px;">发生时间 (Time)</th>
            </tr>
          </thead>
          <tbody>
            {% for log in logs %}
            <tr>
                <td style="color: #64748b;">{{ log.id }}</td>
                <td>
                    <span style="background: rgba(224, 231, 255, 0.6); color: #4338ca; padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 0.8rem;">
                        {{ log.action_type }}
                    </span>
                </td>
                <td style="font-family: monospace; color: #059669;">{{ log.table_name }}</td>
                <td style="font-family: monospace;">#{{ log.record_id }}</td>
                <td style="color: #334155;">{{ log.details }}</td>
                <td style="color: #94a3b8; font-size: 0.9rem;">{{ log.action_time }}</td>
            </tr>
            {% else %}
            <tr><td colspan="6" style="text-align:center; padding:3rem; color: #94a3b8;">
                <i class="ri-inbox-line" style="font-size: 2rem; display: block; margin-bottom: 0.5rem; opacity: 0.5;"></i>
                暂无审计记录 (尝试去加入一个房间触发它！)
            </td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

   {# --- 模块：权限和事务 --- #}
    {% elif active_page == 'security' %}
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

      <div class="dashboard-card" style="border: 1px solid rgba(239, 68, 68, 0.3) !important;">
        <div class="card-content">
          <h3 style="margin-top: 0; color: #b91c1c;"><i class="ri-error-warning-line" style="margin-right: 8px;"></i> 事务级用户封禁</h3>
          <p style="color: #64748b; line-height: 1.6; margin-bottom: 2rem;">
            <span style="background: #fee2e2; color: #b91c1c; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; font-weight: 700;">ACID 事务</span>
            原子性执行：锁定用户 <i class="ri-arrow-right-line"></i> 关闭房间 <i class="ri-arrow-right-line"></i> 下架音乐。
          </p>
          <form method="post" action="{{ url_for('admin.manage_user_transaction') }}" style="display: flex; gap: 0.8rem; margin-top: auto;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="text" name="target_username" placeholder="输入用户名" class="input-tiny" style="flex:1; padding: 1rem; border-radius: 12px; font-size: 1rem; background: rgba(255,255,255,0.5);">
            <button class="modern-action-btn" style="background: #ef4444; color: white; padding: 0 1.5rem; border-radius: 12px; font-size: 1rem;">封禁</button>
          </form>
        </div>
      </div>

      <div class="dashboard-card">
        <div class="card-content">
          <h3 style="margin-top: 0; color: #1e293b;"><i class="ri-shield-keyhole-line" style="color: #10b981; margin-right: 8px;"></i> 权限视图</h3>
          <p style="color: #64748b; line-height: 1.6; margin-bottom: 2rem;">查看当前数据库连接用户的权限分配 (SHOW GRANTS)，确保最小权限原则。</p>
          <div style="margin-top: auto;">
              <button id="btn-view-perms" class="modern-action-btn" style="background: #fff; border: 1px solid #cbd5e1; color: #10b981; padding: 1rem; width: 100%; border-radius: 12px; font-size: 1rem; cursor: pointer;">
                <i class="ri-eye-2-line"></i> 查看权限对比 (DAC)
              </button>
          </div>
        </div>
      </div>

      <script>
// --- 权限解析器：将原始 SQL 转化为结构化对象 ---
function parseGrants(grantsArray) {
    const permissions = [];
    let isSuperUser = false;

    grantsArray.forEach(sql => {
        // 1. 检查是否是超级管理员 (ALL PRIVILEGES)
        if (sql.includes("ALL PRIVILEGES") || sql.includes("GRANT ALL ON *.*")) {
            isSuperUser = true;
            return;
        }

        // 2. 正则提取：GRANT [权限...] ON [库.表] TO ...
        // 匹配示例: GRANT SELECT, INSERT ON `voice_share`.`musics` TO
        const match = sql.match(/GRANT\s+(.*?)\s+ON\s+`?.*?`?\.`?(.*?)`?\s+TO/i);

        if (match) {
            const rawPerms = match[1]; // 例如 "SELECT, INSERT, UPDATE"
            const tableName = match[2]; // 例如 "musics"

            permissions.push({
                table: tableName,
                rights: rawPerms.split(',').map(p => p.trim())
            });
        }
    });

    return { isSuperUser, permissions };
}

// --- 渲染器：生成 HTML ---
function renderPermsHTML(data) {
    if (data.isSuperUser) {
        return `
            <div class="perm-card danger-zone" style="text-align:center; padding: 2rem;">
                <div style="font-size: 3rem; color: #d97706; margin-bottom: 1rem;"><i class="ri-vip-crown-2-fill"></i></div>
                <h3 style="color: #92400e; margin:0;">Root / Admin 级权限</h3>
                <p style="color: #b45309; font-size: 0.9rem;">拥有数据库最高控制权 (ALL PRIVILEGES)</p>
                <div class="perm-badges" style="justify-content:center; margin-top:1rem;">
                    <span class="p-badge p-all"><i class="ri-flashlight-fill"></i> 删库跑路</span>
                    <span class="p-badge p-all"><i class="ri-database-2-fill"></i> 数据恢复</span>
                    <span class="p-badge p-all"><i class="ri-eye-fill"></i> 审计查看</span>
                </div>
            </div>
        `;
    }

    if (data.permissions.length === 0) {
        return `<div style="color:#94a3b8; text-align:center; padding:1rem;">无特定权限或解析失败</div>`;
    }

    return data.permissions.map(item => {
        // 生成标签
        const badges = item.rights.map(r => {
            if (r.includes('SELECT')) return `<span class="p-badge p-select"><i class="ri-eye-line"></i> 查 (Select)</span>`;
            if (r.includes('INSERT')) return `<span class="p-badge p-insert"><i class="ri-add-line"></i> 增 (Insert)</span>`;
            if (r.includes('UPDATE')) return `<span class="p-badge p-update"><i class="ri-edit-line"></i> 改 (Update)</span>`;
            if (r.includes('DELETE')) return `<span class="p-badge p-delete"><i class="ri-delete-bin-line"></i> 删 (Delete)</span>`;
            return `<span class="p-badge" style="background:#f1f5f9; color:#64748b;">${r}</span>`;
        }).join('');

        // 表图标逻辑
        let icon = 'ri-table-line';
        if (item.table.includes('user')) icon = 'ri-user-settings-line';
        if (item.table.includes('music')) icon = 'ri-disc-line';
        if (item.table.includes('room')) icon = 'ri-home-heart-line';
        if (item.table.includes('log')) icon = 'ri-file-list-line';

        return `
            <div class="perm-card">
                <div class="perm-header">
                    <i class="${icon}" style="color: #6366f1;"></i> ${item.table}
                </div>
                <div class="perm-badges">
                    ${badges}
                </div>
            </div>
        `;
    }).join('');
}

document.getElementById('btn-view-perms').addEventListener('click', async () => {
    // 1. Loading
    Swal.fire({
        title: '正在审计权限配置...',
        html: '<div style="color:#64748b">正在对比 DAC 访问控制列表 (ACL)</div>',
        didOpen: () => Swal.showLoading()
    });

    try {
        // 2. Fetch
        const response = await fetch("{{ url_for('admin.get_security_grants') }}");
        const res = await response.json();

        if (res.status === 'success') {
            // 3. 解析数据
            const normalData = parseGrants(res.data.normal);
            const adminData = parseGrants(res.data.admin);

            // 4. 生成 HTML
            const normalHTML = `<div class="perm-container">${renderPermsHTML(normalData)}</div>`;
            const adminHTML = `<div class="perm-container">${renderPermsHTML(adminData)}</div>`;

            // 5. 弹窗展示 (宽屏模式)
            Swal.fire({
                title: '自主存取控制 (DAC) 审计报告',
                width: '900px',
                html: `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; text-align: left; margin-top: 1rem;">

                        <div style="background: #f8fafc; padding: 1.2rem; border-radius: 12px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #475569; margin:0 0 1rem 0; display:flex; align-items:center; gap:8px; border-bottom:2px solid #cbd5e1; padding-bottom:0.5rem;">
                                <i class="ri-user-line" style="background:#cbd5e1; color:#fff; padding:4px; border-radius:50%;"></i>
                                普通通道 (vs_normal)
                            </h4>
                            ${normalHTML}
                            <div style="margin-top:1rem; font-size:0.8rem; color:#10b981; background:#ecfdf5; padding:0.5rem; border-radius:6px;">
                                <i class="ri-shield-check-line"></i> 安全策略：禁止删除用户表，无法访问审计日志。
                            </div>
                        </div>

                        <div style="background: #fff7ed; padding: 1.2rem; border-radius: 12px; border: 1px solid #ffedd5;">
                            <h4 style="color: #9a3412; margin:0 0 1rem 0; display:flex; align-items:center; gap:8px; border-bottom:2px solid #fdba74; padding-bottom:0.5rem;">
                                <i class="ri-shield-star-line" style="background:#fb923c; color:#fff; padding:4px; border-radius:50%;"></i>
                                特权通道 (vs_admin)
                            </h4>
                            ${adminHTML}
                            <div style="margin-top:1rem; font-size:0.8rem; color:#b45309; background:#fffbeb; padding:0.5rem; border-radius:6px;">
                                <i class="ri-alert-line"></i> 风险提示：拥有全库读写权限，需谨慎操作。
                            </div>
                        </div>

                    </div>
                `,
                confirmButtonText: '验证通过 (Verified)',
                confirmButtonColor: '#10b981',
                showCloseButton: true
            });
        } else {
            Swal.fire('查询失败', res.message, 'error');
        }
    } catch (err) {
        console.error(err);
        Swal.fire('执行错误', String(err), 'error');
    }
});
</script>

{# --- 模块：灾备管理 --- #}
  {% elif active_page == 'backup' %}

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <div class="dashboard-card">
      <div class="card-content">
        <h3 style="margin-top: 0; color: #1e293b;"><i class="ri-download-cloud-2-line" style="color: #3b82f6; margin-right: 8px;"></i> 全量备份</h3>
        <p style="color: #64748b; line-height: 1.6; margin-bottom: 2rem;">
          生成当前数据库核心表状态的 JSON 快照文件并下载。<br>
          <span style="font-size: 0.85rem; color: #94a3b8;">包含: User, Room, Music, Playlist, Logs...</span>
        </p>
        <div style="margin-top: auto;">
            <a href="{{ url_for('admin.backup_db') }}" class="modern-action-btn" style="background: linear-gradient(135deg, #3b82f6, #60a5fa); color: #fff; padding: 1rem; width: 100%; border-radius: 12px; display: block; text-align: center; text-decoration: none; font-size: 1rem;">
              <i class="ri-save-3-fill"></i> 导出快照 (Download JSON)
            </a>
        </div>
      </div>
    </div>

    <div class="dashboard-card">
      <div class="card-content">
        <h3 style="margin-top: 0; color: #1e293b;"><i class="ri-upload-cloud-2-line" style="color: #f59e0b; margin-right: 8px;"></i> 数据恢复</h3>
        <p style="color: #64748b; line-height: 1.6; margin-bottom: 2rem;">
          上传备份 JSON 文件，将数据库<strong style="color: #ef4444;">回滚并覆盖</strong>到指定时间点的状态。<br>
          <span style="background: #fef2f2; color: #b91c1c; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">警告：此操作将清空当前所有数据！</span>
        </p>
        <div style="margin-top: auto;">
            <button id="btn-restore-db" class="modern-action-btn" style="background: #fff; border: 1px solid #cbd5e1; color: #f59e0b; padding: 1rem; width: 100%; border-radius: 12px; font-size: 1rem; cursor: pointer;">
              <i class="ri-time-line"></i> 上传并回滚 (Restore)
            </button>
        </div>
      </div>
    </div>

    <script>
    document.getElementById('btn-restore-db').addEventListener('click', async () => {
        // 1. 第一步：上传文件弹窗
        const { value: file } = await Swal.fire({
            title: '上传备份文件',
            text: '请选择之前导出的 .json 全量备份文件',
            input: 'file',
            inputAttributes: {
                'accept': '.json,application/json',
                'aria-label': 'Upload your backup JSON file'
            },
            showCancelButton: true,
            confirmButtonText: '下一步',
            cancelButtonText: '取消',
            confirmButtonColor: '#f59e0b',
        });

        if (file) {
            // 2. 第二步：高危操作二次确认
            const confirmResult = await Swal.fire({
                title: '高危操作警告!',
                html: `即将使用文件 <b>${file.name}</b> 覆盖数据库。<br>此操作将 <span style="color:red;font-weight:bold;">清空并重写</span> 所有数据且无法撤销！`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#cbd5e1',
                confirmButtonText: '是的，我确定覆盖!',
                cancelButtonText: '冷静一下',
                reverseButtons: true
            });

            if (confirmResult.isConfirmed) {
                // 3. 显示 Loading
                Swal.fire({
                    title: '正在数据回滚...',
                    text: '数据库正在重置，请勿关闭浏览器...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // 4. 构造 Form Data 并发送 AJAX
                const formData = new FormData();
                formData.append('file', file);
                // 必须带上 CSRF Token
                formData.append('csrf_token', "{{ csrf_token() }}");

                try {
                    const response = await fetch("{{ url_for('admin.restore_db') }}", {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();

                    if (result.status === 'success') {
                        // 成功后刷新页面
                        Swal.fire({
                            title: '恢复成功!',
                            text: result.message,
                            icon: 'success',
                            confirmButtonColor: '#10b981'
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('恢复失败', result.message, 'error');
                    }
                } catch (error) {
                    Swal.fire('网络错误', '请求发送失败: ' + error, 'error');
                }
            }
        }
    });
    </script>

  {% endif %}

</div>
{% endblock %}