{% extends "layout.html" %}
{% block title %}我的音乐{% endblock %}

{% block content %}
<div class="music-page-wrapper">
  <section class="grid-card upload-card">
    <div class="card-header">
      <div class="header-icon"><i class="ri-upload-cloud-2-line"></i></div>
      <div class="header-text">
        <h1>上传新音乐</h1>
        <p>支持 MP3 格式，单文件限制 50MB。上传即代表确认版权。</p>
      </div>
    </div>

    <form method="post" enctype="multipart/form-data" class="music-upload-form">
      {{ upload_form.hidden_tag() }}

      <div class="form-row">
        <div class="input-group flex-grow">
          <label class="form-label-sm">歌曲名称</label>
          {{ upload_form.title(class="input-modern", placeholder="选填，默认使用文件名") }}
          {% for error in upload_form.title.errors %}
            <div class="error-msg">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="input-group">
          <label class="form-label-sm">音乐文件</label>
          <div class="file-upload-control compact">
            <label for="music_file_input" class="file-select-btn secondary">
              <i class="ri-music-2-fill"></i> 选择 MP3
            </label>
            <span id="music-file-name" class="file-name-text">未选择文件</span>

            {{ upload_form.file(**{'id': 'music_file_input', 'class': 'hidden-input', 'data-autofill-target': upload_form.title.id, 'onchange': 'updateFileName(this)'}) }}

          </div>
          {% for error in upload_form.file.errors %}
            <div class="error-msg">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="input-group button-group">
          <label class="form-label-sm">&nbsp;</label>
          <button type="submit" class="primary-btn">
            <i class="ri-upload-2-line"></i> 上传
          </button>
        </div>
      </div>
    </form>
  </section>

  <section class="music-list-section">
    <div class="section-header">
      <h2>我的音乐库 <span class="count-badge">{{ musics|length }}</span></h2>
    </div>

    <div class="music-grid">
      {% for item in musics %}
        <div class="music-item-card">
          <div class="music-icon">
            <i class="ri-disc-line"></i>
          </div>
          <div class="music-info">
            <h3 class="music-title" title="{{ item.title }}">{{ item.title }}</h3>
            <div class="music-meta">
              <span class="file-name"><i class="ri-file-music-line"></i> {{ item.original_filename }}</span>
              <span class="upload-time"><i class="ri-time-line"></i> {{ item.uploaded_at.strftime('%m-%d %H:%M') }}</span>
            </div>
          </div>
          <div class="music-status">
            {% if item.status == 'pending' %}
              <span class="status-tag pending"><i class="ri-loader-4-line"></i> 审核中</span>
            {% elif item.status == 'approved' %}
              <span class="status-tag success"><i class="ri-check-line"></i> 已通过</span>
            {% else %}
              <span class="status-tag error" title="原因: {{ item.rejection_reason }}"><i class="ri-close-circle-line"></i> 违规/驳回</span>
            {% endif %}
          </div>
          <div class="music-actions">
            <form method="post" action="{{ url_for('main.delete_music', music_id=item.id) }}" onsubmit="return confirm('确定删除这首歌吗？');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
              <button type="submit" class="icon-btn danger" title="删除">
                <i class="ri-delete-bin-line"></i>
              </button>
            </form>
          </div>
        </div>
      {% else %}
        <div class="empty-state">
          <div class="empty-icon"><i class="ri-music-2-line"></i></div>
          <p>还没有上传音乐，快去分享你的第一首歌吧！</p>
        </div>
      {% endfor %}
    </div>
  </section>
</div>

<script>
// 简单的文件名回显脚本
function updateFileName(input) {
  const display = document.getElementById('music-file-name');
  if (input.files && input.files.length > 0) {
    display.textContent = input.files[0].name;
  } else {
    display.textContent = '未选择文件';
  }
}
</script>
{% endblock %}